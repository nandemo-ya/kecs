# アーキテクチャ概要

KECS は、Kubernetes を基盤となるコンテナオーケストレーションプラットフォームとして活用しながら、ECS 互換性を提供するクリーンでモジュラーなアーキテクチャで設計されています。

## ハイレベルアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                        クライアントレイヤー                     │
│  ┌─────────────┐  ┌──────────────┐  ┌──────────────────┐  │
│  │   AWS CLI   │  │   AWS SDKs   │  │     Web UI       │  │
│  └──────┬──────┘  └──────┬───────┘  └────────┬─────────┘  │
└─────────┼─────────────────┼──────────────────┼─────────────┘
          │                 │                   │
          ▼                 ▼                   ▼
┌─────────────────────────────────────────────────────────────┐
│                      API ゲートウェイ                         │
│  ┌──────────────────────────────────────────────────────┐  │
│  │         ECS API ハンドラー (ポート 8080)               │  │
│  │  - REST API エンドポイント                             │  │
│  │  - WebSocket 接続                                    │  │
│  │  - リクエスト検証                                      │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────┐
│                    コントロールプレーン                        │
│  ┌─────────────┐  ┌─────────────┐  ┌──────────────────┐   │
│  │  サービス    │  │   タスク     │  │  タスク定義       │   │
│  │  マネージャー │  │ マネージャー  │  │  マネージャー     │   │
│  └──────┬──────┘  └──────┬──────┘  └────────┬─────────┘   │
│         │                 │                   │              │
│  ┌──────▼─────────────────▼──────────────────▼──────────┐  │
│  │              リソースコンバーター                       │  │
│  │  - ECS から Kubernetes への変換                      │  │
│  │  - 状態の調整                                       │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
          │                                      │
          ▼                                      ▼
┌──────────────────────┐              ┌──────────────────────┐
│   ストレージレイヤー    │              │  Kubernetes クライアント │
│  ┌────────────────┐  │              │  ┌────────────────┐  │
│  │    DuckDB      │  │              │  │  デプロイメント   │  │
│  │  - クラスター   │  │              │  │     管理        │  │
│  │  - サービス     │  │              │  │                │  │
│  │  - タスク      │  │              │  │  Pod/Service   │  │
│  │  - タスク定義   │  │              │  │     作成        │  │
│  └────────────────┘  │              │  └────────────────┘  │
└──────────────────────┘              └──────────────────────┘
```

## コアコンポーネント

### 1. API ゲートウェイレイヤー

API ゲートウェイはすべての受信リクエストを処理し、適切にルーティングします：

- **ECS API サーバー** (ポート 8080)
  - AWS ECS API 仕様を実装
  - REST API リクエストを処理
  - リアルタイム更新のための WebSocket 接続を管理
  - 組み込み Web UI を提供

- **管理サーバー** (ポート 8081)
  - ヘルスチェック (`/health`)
  - メトリクスエンドポイント (`/metrics`)
  - 運用エンドポイント

### 2. コントロールプレーン

コントロールプレーンは ECS リソースのビジネスロジックを実装します：

- **サービスマネージャー**: サービスのライフサイクル（作成、更新、削除）を処理
- **タスクマネージャー**: タスクの実行と状態を管理
- **タスク定義マネージャー**: タスク定義の保存と取得
- **クラスターマネージャー**: ECS クラスターリソースを管理

### 3. リソースコンバーター

ECS と Kubernetes の概念間で変換を行います：

- ECS タスク定義を Kubernetes Deployment/Pod に変換
- ECS サービスを Kubernetes Service にマッピング
- リソース要件と制限を処理
- シークレットと環境変数を管理

### 4. ストレージレイヤー

DuckDB ベースの永続化レイヤー：

- ECS リソース定義を保存
- 状態の一貫性を維持
- リソース検索のための高速クエリを提供
- ACID 保証で同時アクセスを処理

### 5. Kubernetes 統合

Kubernetes API とのインターフェース：

- Pod、Service、ConfigMap の作成と管理
- リソースステータスの監視
- コンテナライフサイクルイベントの処理
- 複数の Kubernetes バックエンドをサポート（Kind、標準クラスター）

## 設計原則

### 1. ECS API 互換性
- Amazon ECS との完全な API 互換性
- 既存のツールと SDK のサポート
- 一貫したエラーメッセージとレスポンス

### 2. クリーンアーキテクチャ
- 関心事の明確な分離
- 依存性注入
- インターフェースベースの設計
- テスト可能なコンポーネント

### 3. Kubernetes ネイティブ
- Kubernetes プリミティブの活用
- Kubernetes パターンの尊重
- Kubernetes エコシステムとの互換性

### 4. 開発者体験
- シンプルなローカルセットアップ
- 包括的な Web UI
- WebSocket によるリアルタイム更新
- 明確なエラーメッセージ

## データフロー

### サービスの作成

1. クライアントが `CreateService` リクエストを API ゲートウェイに送信
2. API ゲートウェイがリクエストを検証し、サービスマネージャーに転送
3. サービスマネージャーが DuckDB にサービスレコードを作成
4. リソースコンバーターが Kubernetes リソースに変換
5. Kubernetes クライアントが Deployment と Service を作成
6. ステータス更新が WebSocket 経由で戻る

### タスクの実行

1. クライアントが `RunTask` リクエストを送信
2. タスクマネージャーがタスク定義の存在を検証
3. リソースコンバーターが Pod 仕様を作成
4. Kubernetes クライアントが Pod を作成
5. タスクマネージャーが Pod ステータスを監視
6. 更新が DuckDB に保存され、WebSocket 経由で送信

## セキュリティの考慮事項

- ローカル開発では認証不要
- 本番環境のデプロイメントでは以下を実装すべき：
  - API 認証（JWT、API キー）
  - すべての通信に TLS
  - Kubernetes のネットワークポリシー
  - ロールベースのアクセス制御

## スケーラビリティ

- コントロールプレーンコンポーネントの水平スケーリング
- DuckDB は数千のリソースを効率的に処理
- Kubernetes はワークロードの自然なスケーリングを提供
- WebSocket 接続は効率的な pub/sub モデルを使用

## 次のステップ

- [コントロールプレーンの詳細](/ja/architecture/control-plane)
- [ストレージレイヤーの設計](/ja/architecture/storage)
- [Kubernetes 統合](/ja/architecture/kubernetes)
- [Web UI アーキテクチャ](/ja/architecture/web-ui)