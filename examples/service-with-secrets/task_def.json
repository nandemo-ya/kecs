{
  "family": "service-with-secrets",
  "networkMode": "awsvpc",
  "requiresCompatibilities": ["FARGATE"],
  "cpu": "256",
  "memory": "512",
  "containerDefinitions": [
    {
      "name": "app",
      "image": "python:3.9-alpine",
      "essential": true,
      "command": [
        "sh", "-c",
        "echo 'aW1wb3J0IG9zCmltcG9ydCBqc29uCmZyb20gaHR0cC5zZXJ2ZXIgaW1wb3J0IEhUVFBTZXJ2ZXIsIEJhc2VIVFRQUmVxdWVzdEhhbmRsZXIKCmNsYXNzIEhhbmRsZXIoQmFzZUhUVFBSZXF1ZXN0SGFuZGxlcik6CiAgICBkZWYgZG9fR0VUKHNlbGYpOgogICAgICAgIGlmIHNlbGYucGF0aCA9PSAnL2hlYWx0aCc6CiAgICAgICAgICAgIHNlbGYuc2VuZF9yZXNwb25zZSgyMDApCiAgICAgICAgICAgIHNlbGYuc2VuZF9oZWFkZXIoJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi9qc29uJykKICAgICAgICAgICAgc2VsZi5lbmRfaGVhZGVycygpCiAgICAgICAgICAgIHNlbGYud2ZpbGUud3JpdGUoanNvbi5kdW1wcyh7J3N0YXR1cyc6ICdoZWFsdGh5J30pLmVuY29kZSgpKQogICAgICAgIGVsaWYgc2VsZi5wYXRoID09ICcvY29uZmlnJzoKICAgICAgICAgICAgc2VsZi5zZW5kX3Jlc3BvbnNlKDIwMCkKICAgICAgICAgICAgc2VsZi5zZW5kX2hlYWRlcignQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKQogICAgICAgICAgICBzZWxmLmVuZF9oZWFkZXJzKCkKICAgICAgICAgICAgY29uZmlnID0gewogICAgICAgICAgICAgICAgJ2RhdGFiYXNlX3VybCc6IG9zLmVudmlyb24uZ2V0KCdEQVRBQkFTRV9VUkwnLCAnbm90X3NldCcpLAogICAgICAgICAgICAgICAgJ2FwaV9rZXlfcHJlc2VudCc6IGJvb2wob3MuZW52aXJvbi5nZXQoJ0FQSV9LRVknKSksCiAgICAgICAgICAgICAgICAnYXBwX2NvbmZpZyc6IG9zLmVudmlyb24uZ2V0KCdBUFBfQ09ORklHJywgJ25vdF9zZXQnKSwKICAgICAgICAgICAgICAgICdmZWF0dXJlX2ZsYWdzJzogb3MuZW52aXJvbi5nZXQoJ0ZFQVRVUkVfRkxBR1MnLCAnbm90X3NldCcpLAogICAgICAgICAgICAgICAgJ2Vudmlyb25tZW50Jzogb3MuZW52aXJvbi5nZXQoJ0VOVklST05NRU5UJywgJ25vdF9zZXQnKQogICAgICAgICAgICB9CiAgICAgICAgICAgIHNlbGYud2ZpbGUud3JpdGUoanNvbi5kdW1wcyhjb25maWcsIGluZGVudD0yKS5lbmNvZGUoKSkKICAgICAgICBlbGlmIHNlbGYucGF0aCA9PSAnL3NlY3JldHMnOgogICAgICAgICAgICBzZWxmLnNlbmRfcmVzcG9uc2UoMjAwKQogICAgICAgICAgICBzZWxmLnNlbmRfaGVhZGVyKCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpCiAgICAgICAgICAgIHNlbGYuZW5kX2hlYWRlcnMoKQogICAgICAgICAgICAjIE5ldmVyIGV4cG9zZSBhY3R1YWwgc2VjcmV0cywganVzdCBjb25maXJtIHRoZXkgZXhpc3QKICAgICAgICAgICAgc2VjcmV0cyA9IHsKICAgICAgICAgICAgICAgICdkYl9wYXNzd29yZF9sb2FkZWQnOiBib29sKG9zLmVudmlyb24uZ2V0KCdEQl9QQVNTV09SRCcpKSwKICAgICAgICAgICAgICAgICdqd3Rfc2VjcmV0X2xvYWRlZCc6IGJvb2wob3MuZW52aXJvbi5nZXQoJ0pXVF9TRUNSRVQnKSksCiAgICAgICAgICAgICAgICAnZW5jcnlwdGlvbl9rZXlfbG9hZGVkJzogYm9vbChvcy5lbnZpcm9uLmdldCgnRU5DUllQVElPTl9LRVknKSkKICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmLndmaWxlLndyaXRlKGpzb24uZHVtcHMoc2VjcmV0cywgaW5kZW50PTIpLmVuY29kZSgpKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYuc2VuZF9yZXNwb25zZSg0MDQpCiAgICAgICAgICAgIHNlbGYuZW5kX2hlYWRlcnMoKQoKaWYgX19uYW1lX18gPT0gJ19fbWFpbl9fJzoKICAgIHByaW50KCdTdGFydGluZyBzZXJ2ZXIgb24gcG9ydCA4MDgwLi4uJykKICAgIHByaW50KCdFbnZpcm9ubWVudDonLCBvcy5lbnZpcm9uLmdldCgnRU5WSVJPTk1FTlQnLCAnbm90X3NldCcpKQogICAgaHR0cGQgPSBIVFRQU2VydmVyKCgnJywgODA4MCksIEhhbmRsZXIpCiAgICBodHRwZC5zZXJ2ZV9mb3JldmVyKCk=' | base64 -d > /tmp/server.py && python /tmp/server.py"
      ],
      "portMappings": [
        {
          "containerPort": 8080,
          "protocol": "tcp"
        }
      ],
      "environment": [
        {
          "name": "ENVIRONMENT",
          "value": "production"
        },
        {
          "name": "APP_CONFIG",
          "value": "server=app.example.com;timeout=30;retries=3"
        }
      ],
      "secrets": [
        {
          "name": "DATABASE_URL",
          "valueFrom": "arn:aws:ssm:us-east-1:000000000000:parameter/myapp/prod/database-url"
        },
        {
          "name": "API_KEY",
          "valueFrom": "arn:aws:ssm:us-east-1:000000000000:parameter/myapp/prod/api-key"
        },
        {
          "name": "FEATURE_FLAGS",
          "valueFrom": "arn:aws:ssm:us-east-1:000000000000:parameter/myapp/prod/feature-flags"
        },
        {
          "name": "DB_PASSWORD",
          "valueFrom": "arn:aws:secretsmanager:us-east-1:000000000000:secret:myapp/prod/db"
        },
        {
          "name": "JWT_SECRET",
          "valueFrom": "arn:aws:secretsmanager:us-east-1:000000000000:secret:myapp/prod/jwt"
        },
        {
          "name": "ENCRYPTION_KEY",
          "valueFrom": "arn:aws:secretsmanager:us-east-1:000000000000:secret:myapp/prod/encryption"
        }
      ],
      "healthCheck": {
        "command": ["CMD-SHELL", "wget -q -O - http://localhost:8080/health || exit 1"],
        "interval": 30,
        "timeout": 5,
        "retries": 3,
        "startPeriod": 30
      },
      "logConfiguration": {
        "logDriver": "awslogs",
        "options": {
          "awslogs-group": "/ecs/service-with-secrets",
          "awslogs-region": "us-east-1",
          "awslogs-stream-prefix": "app"
        }
      }
    }
  ],
  "executionRoleArn": "arn:aws:iam::000000000000:role/ecsTaskExecutionRole",
  "taskRoleArn": "arn:aws:iam::000000000000:role/ecsTaskRole"
}